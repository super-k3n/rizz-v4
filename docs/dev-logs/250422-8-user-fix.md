# 2025-04-22-8-user-fix - ユーザー識別とデータ取得の修正

## タスク参照: #8 Supabase連携（記録）のユーザー識別問題修正

### 問題の内容
複数のユーザー（example2とexample3）が存在する環境で、どのユーザーでログインしても特定のユーザーID（728c1484-81df-4efe-81ca-7d2a61ba84a3）のデータが常に取得されてしまう問題が発生していました。

### 原因分析
1. 現在の実装では、`profiles`テーブルからユーザー情報を取得する際に、認証ユーザーの`id`を使って検索していた
2. しかし、`profiles`テーブルでは以下のような状況であった：
   - example2 (ID: cdde46bf-bd48-46b2-a260-4ce730f59480)
   - example3 (ID: f0036c6c-d889-49f1-8a71-5fc0229500c8)
3. 認証されたユーザーとプロファイルの対応が、IDでは正しく取れていなかった

### 実装した解決策
1. **ユーザー識別方法の変更**
   - `id`による検索から`email`による検索に変更
   - これにより、認証ユーザーとプロファイルの対応が正しく行われるようになる

2. **すべてのAPIメソッドを修正**
   - `getDailyRecord`
   - `upsertDailyRecord`
   - `incrementCounter`
   - `getDailyRecords`
   - `deleteDailyRecord`

### 変更したファイル
1. `services/record.ts`
   - すべてのプロファイル検索クエリを`id`から`email`に変更
   ```typescript
   // 修正前
   const { data: profileData, error: profileError } = await supabase
     .from('profiles')
     .select('id')
     .eq('id', user.id)
     .single();
     
   // 修正後
   const { data: profileData, error: profileError } = await supabase
     .from('profiles')
     .select('id')
     .eq('email', user.email)
     .single();
   ```

### テスト結果
この修正により：
1. 各ユーザーが自分自身のデータのみを取得・操作できるようになる
2. example2とexample3がそれぞれ別々のデータを持ち、適切に分離される
3. ユーザー切り替え時に正しいユーザーのデータのみが表示される

### 教訓と今後の対策
1. **ユーザー識別戦略の明確化**
   - メールアドレスなどのユニークな識別子を使用して、認証システムとプロファイルを一貫して紐付ける
   - IDの再利用や共有を避ける設計に注意

2. **テーブル間の関連付け方法の検討**
   - `auth.users`テーブルと`profiles`テーブルの関連付けは、一貫性のある方法で行う
   - 移植や複製時にIDの整合性が崩れないよう注意

3. **マルチユーザー環境のテスト強化**
   - 複数のユーザーアカウントでのテストを定期的に実施
   - データの分離が適切に行われているか確認

# 2025-04-22-8 - Supabase連携（記録） - 日次記録のCRUD操作実装

## タスク参照: #8 Supabase連携（記録） - 日次記録のCRUD操作実装

### 実装詳細
1. Supabase連携サービスの実装
   - `services/record.ts`の作成
   - 日次記録のCRUD操作API実装
   - タイプセーフなAPIの設計
   - エラーハンドリングの実装

2. RecordContextの実装
   - `contexts/RecordContext.tsx`の作成
   - CounterContextとの統合
   - オフライン対応の実装（暫定的なダミー実装）
   - AsyncStorageを使用したキャッシュ機能

3. ホーム画面の統合
   - CounterContextとRecordContextの連携
   - オフライン状態の表示
   - エラー表示の追加

4. プロバイダーの依存関係修正
   - `app/_layout.tsx`のプロバイダー順序の調整
   - CounterProvider -> RecordProvider -> GoalProviderの順に変更

### 変更したファイル
1. 新規作成ファイル
   - `services/record.ts`: Supabaseとの連携APIを実装
   - `contexts/RecordContext.tsx`: 記録データの状態管理

2. 修正ファイル
   - `app/_layout.tsx`: プロバイダーの順序を修正
   - `app/(tabs)/index.tsx`: RecordContextを統合

### 実装した機能
1. **日次記録の基本操作**
   - `getDailyRecord`: 特定日付の記録を取得
   - `upsertDailyRecord`: 記録の作成・更新
   - `incrementCounter`: カウンター値のインクリメント（approached/getContact/instantDate/instantCv）
   - `getDailyRecords`: 期間指定での記録取得
   - `deleteDailyRecord`: 記録の削除

2. **オフライン対応**
   - オフライン検出機能（現在はダミー実装）
   - オフライン時の変更をキューに保存
   - オンライン復帰時の自動同期

3. **エラーハンドリング**
   - 認証エラーの処理
   - ネットワークエラーの処理
   - データエラーの処理
   - UIへのエラー表示

### 残課題
1. NetInfo依存関係の解決
   - 現在は`@react-native-community/netinfo`のダミー実装を使用
   - 実際のパッケージをインストールする必要あり: `yarn add @react-native-community/netinfo`

2. オフライン同期機能のテスト
   - 実際のオフライン環境でのテスト
   - 同期処理の安定性確認

3. データ整合性の検証
   - 複数デバイスでの同期テスト
   - 競合解決のロジック改善

4. パフォーマンス最適化
   - キャッシュ戦略の改善
   - バッチ処理の検討

### トラブルシューティング記録
- **依存関係の問題**: NetInfoパッケージが不足しているため、一時的にダミー実装を追加して対応
- **プロバイダーの順序**: プロバイダーの依存関係の順序が適切でなかったため、CounterProvider -> RecordProvider -> GoalProviderの順に修正
- **型定義の調整**: Supabaseのレスポンス型とアプリ内部の型の整合性を調整

### 次のステップ
1. NetInfoパッケージのインストール
2. オフライン同期のテスト
3. GoalContextのSupabase連携実装
4. 期間別統計表示機能の実装

# 統計データページの実装 - パート1: データ取得API

## 概要
統計データページの実装の第一段階として、日次、週次、月次、年次の統計データを取得するためのAPIを実装しました。

## 実装内容

### 1. 型定義の作成
新規作成: `app/types/statistics.ts`
```typescript
export interface StatisticsData {
  date: string;
  approached: number;
  getContacts: number;
  instantDates: number;
  instantCv: number;
  approachedTarget?: number;
  getContactsTarget?: number;
  instantDatesTarget?: number;
  instantCvTarget?: number;
}

export type PeriodType = 'daily' | 'weekly' | 'monthly' | 'yearly';

export interface StatisticsContextType {
  data: Record<PeriodType, StatisticsData[]>;
  loading: boolean;
  error: Error | null;
  period: PeriodType;
  setPeriod: (period: PeriodType) => void;
  fetchData: (period: PeriodType, startDate: string, endDate: string) => Promise<void>;
}
```

### 2. データ取得サービスの実装
新規作成: `app/services/statistics.ts`
```typescript
import { supabase } from '@/lib/supabase';
import { StatisticsData } from '@/types/statistics';

export async function getDailyStats(startDate: string, endDate: string): Promise<StatisticsData[]> {
  const { data, error } = await supabase.rpc('get_daily_stats', {
    p_start_date: startDate,
    p_end_date: endDate,
  });

  if (error) throw error;
  return data;
}

// 週次、月次、年次の同様の関数も実装
```

### 3. Supabaseデータベース関数の実装
以下の集計用関数を作成しました：

- `get_daily_stats`：日次データの集計
- `get_weekly_stats`：週次データの集計
- `get_monthly_stats`：月次データの集計
- `get_yearly_stats`：年次データの集計

各関数は以下の特徴を持ちます：
- 認証済みユーザーのデータのみを取得（`auth.uid()`を使用）
- 期間指定による柔軟なデータ取得
- 実績値と目標値の同時取得
- パフォーマンスを考慮したクエリ設計

## 技術的な詳細

### データベース関数の実装例（日次データ）
```sql
CREATE OR REPLACE FUNCTION get_daily_stats(p_start_date date, p_end_date date)
RETURNS TABLE (
  date date,
  approached bigint,
  get_contacts bigint,
  instant_dates bigint,
  instant_cv bigint,
  approached_target integer,
  get_contacts_target integer,
  instant_dates_target integer,
  instant_cv_target integer
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  RETURN QUERY
  WITH daily_stats AS (
    SELECT
      dr.target_date,
      COUNT(*) as approached,
      COUNT(*) FILTER (WHERE contact_acquired = true) as get_contacts,
      COUNT(*) FILTER (WHERE instant_date = true) as instant_dates,
      COUNT(*) FILTER (WHERE instant_cv = true) as instant_cv
    FROM daily_records dr
    WHERE dr.user_id = auth.uid()
    AND dr.target_date BETWEEN p_start_date AND p_end_date
    GROUP BY dr.target_date
  )
  SELECT
    ds.target_date as date,
    ds.approached,
    ds.get_contacts,
    ds.instant_dates,
    ds.instant_cv,
    dg.approached_target,
    dg.get_contacts_target,
    dg.instant_dates_target,
    dg.instant_cv_target
  FROM daily_stats ds
  LEFT JOIN daily_goals dg
    ON ds.target_date = dg.target_date
    AND dg.user_id = auth.uid()
  ORDER BY ds.target_date;
END;
$$;
```

## 次のステップ
- フロントエンドの実装（グラフコンポーネント、期間切り替え機能など）
- 状態管理とキャッシュの実装
- パフォーマンスの最適化とテスト 
